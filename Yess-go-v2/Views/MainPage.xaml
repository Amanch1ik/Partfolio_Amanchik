<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="YessGoFront.Views.MainPage"
    x:Name="MainPageElement"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:YessGoFront.ViewModels"
    xmlns:models="clr-namespace:YessGoFront.Models"
    xmlns:controls="clr-namespace:YessGoFront.Views.Controls"
    xmlns:services="clr-namespace:YessGoFront.Services"
    xmlns:converters="clr-namespace:YessGoFront.Converters"
    xmlns:helpers="clr-namespace:YessGoFront.Helpers"
    x:DataType="viewmodels:MainPageViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="#F4F6F8">

    <!-- ViewModel Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð² code-behind Ñ DI -->
    
    <ContentPage.Resources>
        <converters:StringToImageSourceConverter x:Key="ImageSourceConverter"/>
        <converters:ProgressToWidthMultiConverter x:Key="ProgressToWidthMultiConverter"/>
        <converters:StoryProgressWidthConverter x:Key="StoryProgressWidthConverter"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">

        <!-- ===== ÐŸÐ ÐžÐšÐ Ð£Ð§Ð˜Ð’ÐÐ•ÐœÐ«Ð™ ÐšÐžÐÐ¢Ð•ÐÐ¢ ===== -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="0">

                <!-- ===== Ð¨ÐÐŸÐšÐ ===== -->
                <Border StrokeThickness="0"
                        BackgroundColor="#0F6B53"
                        StrokeShape="RoundRectangle 0,0,10,10"
                        Padding="{OnPlatform Android='16,36,16,14', iOS='16,48,16,14'}">
                    <VerticalStackLayout Spacing="16">

                        <!-- ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ -->
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                            <Frame Grid.Column="0"
                                   WidthRequest="56" HeightRequest="56"
                                   CornerRadius="28" Padding="0"
                                   BackgroundColor="#FFFFFF33">
                                <Image Source="profile.png" Aspect="AspectFill"/>
                            </Frame>

                            <VerticalStackLayout Grid.Column="1"
                     Spacing="2"
                     VerticalOptions="Center">
                                <Label FontSize="20"
           FontAttributes="Bold"
           TextColor="White"
           Text="{Binding DisplayName}" />
                                <Label FontSize="12"
           TextColor="#FFFFFFCC"
           Text="{Binding Phone}" />
                            </VerticalStackLayout>

                        </Grid>

                        <!-- ÐšÐ¾ÑˆÐµÐ»Ñ‘Ðº -->
                        <Frame WidthRequest="360"
                               HeightRequest="130"
                               HorizontalOptions="Center"
                               Padding="14"
                               CornerRadius="18"
                               HasShadow="True"
                               BackgroundColor="White">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnWalletTapped"/>
                            </Frame.GestureRecognizers>

                            <Grid RowDefinitions="Auto,*" ColumnDefinitions="*,Auto">
                                <Label Text="Ð’Ð°Ñˆ Ð‘Ð°Ð»Ð°Ð½Ñ"
                                       Grid.Row="0" Grid.Column="0"
                                       TextColor="#DAA520"
                                       FontSize="13"/>
                                <Button Text="Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ"
                                        Grid.Row="0" Grid.Column="1"
                                        BackgroundColor="White"
                                        TextColor="#7A7A7A"
                                        Padding="10,4"
                                        CornerRadius="10"
                                        FontSize="13"
                                        Clicked="OnHistoryClicked"/>
                                <Grid Grid.Row="1" Grid.ColumnSpan="2"
                                      ColumnDefinitions="*,Auto"
                                      VerticalOptions="End"
                                      Padding="0,0,0,2">
                                    <HorizontalStackLayout Grid.Column="0" Spacing="8" VerticalOptions="End">
                                        <Label Text="{Binding Balance}"
                                               FontSize="30"
                                               FontAttributes="Bold"
                                               TextColor="#0F6B53"/>
                                        <Frame BackgroundColor="#EEF2F7" CornerRadius="10" Padding="8,2">
                                            <Label Text="Yess!Coin"
                                                   TextColor="#0F6B53"
                                                   FontAttributes="Bold"
                                                   FontSize="13"/>
                                        </Frame>
                                    </HorizontalStackLayout>
                                    <Image Grid.Column="1"
                                           Source="coin.png"
                                           WidthRequest="40" HeightRequest="40"
                                           HorizontalOptions="End"
                                           VerticalOptions="End"
                                           Margin="0,0,0,2"/>
                                </Grid>
                            </Grid>
                        </Frame>
                    </VerticalStackLayout>
                </Border>

                <!-- ===== ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ ÐšÐžÐÐ¢Ð•ÐÐ¢ ===== -->
                <VerticalStackLayout Spacing="16" Padding="16,12,16,20">

                    <!-- Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ -->
                    <Label Text="Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿"
                           FontAttributes="Bold"
                           FontSize="16"
                           TextColor="#333"
                           Margin="0,0,0,4"/>

                    <CollectionView ItemsSource="{Binding Stories}"
                                    ItemsLayout="HorizontalList"
                                    SelectionMode="None"
                                    HeightRequest="100"
                                    HorizontalScrollBarVisibility="Never">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:StoryModel">
                                <VerticalStackLayout Padding="4" Spacing="4" WidthRequest="80">
                                    <Border WidthRequest="64" HeightRequest="64"
                                            BackgroundColor="White"
                                            Stroke="#DAA520" StrokeThickness="2"
                                            HorizontalOptions="Center" VerticalOptions="Center">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="32"/>
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding BindingContext.OpenStoryAsyncCommand, Source={x:Reference MainPageElement}}"
                                                CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Image Source="{Binding Icon}" Aspect="AspectFill"/>
                                    </Border>
                                    <Label Text="{Binding Title}"
                                           FontSize="12"
                                           HorizontalTextAlignment="Center"
                                           TextColor="#333"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="1"/>
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>



                    <CollectionView x:Name="BannersCollection"
                            ItemsSource="{Binding Banners}"
                            ItemsLayout="HorizontalList"
                            SelectionMode="None"
                            HorizontalScrollBarVisibility="Never"
                            Margin="0,0,0,4"
                            VerticalOptions="Start"
                            HeightRequest="90">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:BannerModel">
                                <Grid WidthRequest="160"
                                      HeightRequest="90"
                                      Margin="0,0,12,0">
                                    <Border StrokeThickness="0"
                                           StrokeShape="RoundRectangle 16"
                                           Padding="0"
                                           BackgroundColor="#E0E0E0">
                                        <Grid>
                                            <!-- Placeholder (ÑÐµÑ€Ñ‹Ð¹ Ñ„Ð¾Ð½ Ñ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð¼) -->
                                            <Grid x:Name="BannerPlaceholder"
                                                  BackgroundColor="#E0E0E0"
                                                  HorizontalOptions="Fill"
                                                  VerticalOptions="Fill">
                                                <ActivityIndicator IsRunning="True"
                                                                 Color="#007A51"
                                                                 VerticalOptions="Center"
                                                                 HorizontalOptions="Center"/>
                                            </Grid>
                                            
                                            <!-- Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ (Ð¿Ð¾Ð²ÐµÑ€Ñ… placeholder) -->
                                            <Image Source="{Binding Image, Converter={StaticResource ImageSourceConverter}}" 
                                                   Aspect="AspectFill"
                                                   HorizontalOptions="Fill"
                                                   VerticalOptions="Fill"
                                                   BackgroundColor="#F0F0F0">
                                                <Image.Behaviors>
                                                    <helpers:ImageLoadingBehavior />
                                                </Image.Behaviors>
                                            </Image>
                                            <!-- Fallback Ñ‚ÐµÐºÑÑ‚, ÐµÑÐ»Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð¾ÑÑŒ -->
                                            <Label Text="ðŸ“·"
                                                   FontSize="40"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   TextColor="#999"
                                                   IsVisible="False"
                                                   x:Name="BannerFallback"/>
                                        </Grid>
                                    </Border>
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding BindingContext.OpenBannerAsyncCommand, Source={x:Reference MainPageElement}}"
                                                              CommandParameter="{Binding .}"/>
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>


                    <!-- ðŸ”¹ Ð›ÐµÐ½Ñ‚Ð° ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹ -->
                    <ScrollView Orientation="Horizontal"
            HorizontalScrollBarVisibility="Never"
            Margin="0"
            HeightRequest="160">
                        <HorizontalStackLayout Spacing="12"
                           Padding="12,0,12,0">

                            <!-- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ 1 -->
                            <VerticalStackLayout Spacing="6"
                             WidthRequest="120"
                             HorizontalOptions="Center">
                                <Frame WidthRequest="120"
                   HeightRequest="120"
                   CornerRadius="12"
                   Padding="0"
                   HasShadow="True"
                   IsClippedToBounds="True"
                   BackgroundColor="White">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="beauty" />
                                    </Frame.GestureRecognizers>
                                    <Image Source="cat_beauty.png"
                       Aspect="AspectFill"
                       HorizontalOptions="Fill"
                       VerticalOptions="Fill"/>
                                </Frame>
                                <Label Text="Ð¡Ð°Ð»Ð¾Ð½Ñ‹ ÐºÑ€Ð°ÑÐ¾Ñ‚Ñ‹"
                   FontSize="13"
                   FontAttributes="Bold"
                   TextColor="#333"
                   HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>

                            <!-- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ 2 -->
                            <VerticalStackLayout Spacing="6"
                             WidthRequest="120"
                             HorizontalOptions="Center">
                                <Frame WidthRequest="120"
                   HeightRequest="120"
                   CornerRadius="12"
                   Padding="0"
                   HasShadow="True"
                   IsClippedToBounds="True"
                   BackgroundColor="White">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="pharmacy" />
                                    </Frame.GestureRecognizers>
                                    <Image Source="cat_beauty.png"
                       Aspect="AspectFill"
                       HorizontalOptions="Fill"
                       VerticalOptions="Fill"/>
                                </Frame>
                                <Label Text="ÐÐ¿Ñ‚ÐµÐºÐ¸"
                   FontSize="13"
                   FontAttributes="Bold"
                   TextColor="#333"
                   HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>

                            <!-- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ 3 -->
                            <VerticalStackLayout Spacing="6"
                             WidthRequest="120"
                             HorizontalOptions="Center">
                                <Frame WidthRequest="120"
                   HeightRequest="120"
                   CornerRadius="12"
                   Padding="0"
                   HasShadow="True"
                   IsClippedToBounds="True"
                   BackgroundColor="White">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="groceries" />
                                    </Frame.GestureRecognizers>
                                    <Image Source="cat_food.png"
                       Aspect="AspectFill"
                       HorizontalOptions="Fill"
                       VerticalOptions="Fill"/>
                                </Frame>
                                <Label Text="ÐœÐ°Ð³Ð°Ð·Ð¸Ð½Ñ‹"
                   FontSize="13"
                   FontAttributes="Bold"
                   TextColor="#333"
                   HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>

                            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° â€œÐ•Ñ‰Ñ‘...â€ -->
                            <VerticalStackLayout Spacing="6"
                             WidthRequest="120"
                             HorizontalOptions="Center">
                                <Frame WidthRequest="120"
                   HeightRequest="120"
                   CornerRadius="12"
                   Padding="0"
                   HasShadow="True"
                   BackgroundColor="#F3F3F3"
                   HorizontalOptions="Center">
                                    <Grid>
                                        <Label Text="+"
                           FontSize="48"
                           FontAttributes="Bold"
                           TextColor="#0F6B53"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnMoreTapped" />
                                        </Grid.GestureRecognizers>
                                    </Grid>
                                </Frame>
                                <Label Text="Ð•Ñ‰Ñ‘..."
                   FontSize="13"
                   FontAttributes="Bold"
                   TextColor="#555"
                   HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>

                        </HorizontalStackLayout>
                    </ScrollView>






                    <!-- ===== ÐÐ°ÑˆÐ¸ Ð¿Ð°Ñ€Ñ‚Ð½Ñ‘Ñ€Ñ‹ ===== -->
                    <Label Text="ÐÐ°ÑˆÐ¸ Ð¿Ð°Ñ€Ñ‚Ð½Ñ‘Ñ€Ñ‹"
                           FontAttributes="Bold"
                           FontSize="16"
                           TextColor="#555"
                           Margin="0,2,0,0"/>

                    <!-- ðŸ”¹ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº Ñ ScrollView Ð´Ð»Ñ Ð±ÐµÑÑˆÐ¾Ð²Ð½Ð¾Ð¹ Ð¿Ñ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ¸ -->
                    <VerticalStackLayout Spacing="0" Padding="0" Margin="0">

                        <!-- Ð ÑÐ´ 1 -->
                        <ScrollView x:Name="Row1"
                                    Orientation="Horizontal"
                                    HeightRequest="98"
                                    HorizontalScrollBarVisibility="Never"
                                    VerticalScrollBarVisibility="Never"
                                    VerticalOptions="Start">
                            <HorizontalStackLayout x:Name="Row1Panel"
                                                   Spacing="20"
                                                   Padding="24,0"
                                                   BindableLayout.ItemsSource="{Binding PartnersRow1}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:PartnerLogoModel">
                                        <Grid WidthRequest="84" HeightRequest="84">
                                            <Border Padding="0"
                                                    BackgroundColor="White"
                                                    Stroke="#0F6B53"
                                                    StrokeThickness="1">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="42"/>
                                                </Border.StrokeShape>
                                                <Grid>
                                                    <!-- Placeholder -->
                                                    <Grid x:Name="PartnerPlaceholder"
                                                          BackgroundColor="#E0E0E0"
                                                          HorizontalOptions="Fill"
                                                          VerticalOptions="Fill">
                                                        <ActivityIndicator IsRunning="True"
                                                                           Color="#0F6B53"
                                                                           VerticalOptions="Center"
                                                                           HorizontalOptions="Center"
                                                                           WidthRequest="20"
                                                                           HeightRequest="20"/>
                                                    </Grid>
                                                    <!-- Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ -->
                                                    <Image Source="{Binding Logo, Converter={StaticResource ImageSourceConverter}}"
                                                           Aspect="AspectFill"
                                                           HorizontalOptions="Fill"
                                                           VerticalOptions="Fill">
                                                        <Image.Behaviors>
                                                            <helpers:ImageLoadingBehavior />
                                                        </Image.Behaviors>
                                                    </Image>
                                                </Grid>
                                            </Border>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding BindingContext.OpenPartnerAsyncCommand, Source={x:Reference MainPageElement}}"
                                                    CommandParameter="{Binding .}" />
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </ScrollView>

                        <!-- Ð ÑÐ´ 2 -->
                        <ScrollView x:Name="Row2"
                                    Orientation="Horizontal"
                                    HeightRequest="98"
                                    HorizontalScrollBarVisibility="Never"
                                    VerticalScrollBarVisibility="Never"
                                    VerticalOptions="Start">
                            <HorizontalStackLayout x:Name="Row2Panel"
                                                   Spacing="20"
                                                   Padding="24,0"
                                                   BindableLayout.ItemsSource="{Binding PartnersRow2}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:PartnerLogoModel">
                                        <Grid WidthRequest="84" HeightRequest="84">
                                            <Border Padding="0"
                                                    BackgroundColor="White"
                                                    Stroke="#0F6B53"
                                                    StrokeThickness="1">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="42"/>
                                                </Border.StrokeShape>
                                                <Grid>
                                                    <!-- Placeholder -->
                                                    <Grid x:Name="PartnerPlaceholder"
                                                          BackgroundColor="#E0E0E0"
                                                          HorizontalOptions="Fill"
                                                          VerticalOptions="Fill">
                                                        <ActivityIndicator IsRunning="True"
                                                                           Color="#0F6B53"
                                                                           VerticalOptions="Center"
                                                                           HorizontalOptions="Center"
                                                                           WidthRequest="20"
                                                                           HeightRequest="20"/>
                                                    </Grid>
                                                    <!-- Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ -->
                                                    <Image Source="{Binding Logo, Converter={StaticResource ImageSourceConverter}}"
                                                           Aspect="AspectFill"
                                                           HorizontalOptions="Fill"
                                                           VerticalOptions="Fill">
                                                        <Image.Behaviors>
                                                            <helpers:ImageLoadingBehavior />
                                                        </Image.Behaviors>
                                                    </Image>
                                                </Grid>
                                            </Border>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding BindingContext.OpenPartnerAsyncCommand, Source={x:Reference MainPageElement}}"
                                                    CommandParameter="{Binding .}" />
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </ScrollView>

                        <!-- Ð ÑÐ´ 3 -->
                        <ScrollView x:Name="Row3"
                                    Orientation="Horizontal"
                                    HeightRequest="98"
                                    HorizontalScrollBarVisibility="Never"
                                    VerticalScrollBarVisibility="Never"
                                    VerticalOptions="Start">
                            <HorizontalStackLayout x:Name="Row3Panel"
                                                   Spacing="20"
                                                   Padding="24,0"
                                                   BindableLayout.ItemsSource="{Binding PartnersRow3}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:PartnerLogoModel">
                                        <Grid WidthRequest="84" HeightRequest="84">
                                            <Border Padding="0"
                                                    BackgroundColor="White"
                                                    Stroke="#0F6B53"
                                                    StrokeThickness="1">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="42"/>
                                                </Border.StrokeShape>
                                                <Grid>
                                                    <!-- Placeholder -->
                                                    <Grid x:Name="PartnerPlaceholder"
                                                          BackgroundColor="#E0E0E0"
                                                          HorizontalOptions="Fill"
                                                          VerticalOptions="Fill">
                                                        <ActivityIndicator IsRunning="True"
                                                                           Color="#0F6B53"
                                                                           VerticalOptions="Center"
                                                                           HorizontalOptions="Center"
                                                                           WidthRequest="20"
                                                                           HeightRequest="20"/>
                                                    </Grid>
                                                    <!-- Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ -->
                                                    <Image Source="{Binding Logo, Converter={StaticResource ImageSourceConverter}}"
                                                           Aspect="AspectFill"
                                                           HorizontalOptions="Fill"
                                                           VerticalOptions="Fill">
                                                        <Image.Behaviors>
                                                            <helpers:ImageLoadingBehavior />
                                                        </Image.Behaviors>
                                                    </Image>
                                                </Grid>
                                            </Border>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding BindingContext.OpenPartnerAsyncCommand, Source={x:Reference MainPageElement}}"
                                                    CommandParameter="{Binding .}" />
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                        </ScrollView>

                    </VerticalStackLayout>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- ===== ÐÐ˜Ð–ÐÐ˜Ð™ ÐÐÐ’Ð‘ÐÐ  ===== -->
        <controls:BottomNavBar x:Name="BottomBar" Grid.Row="1" />

        <!-- ====== OVERLAY: Story (full-screen) ====== -->
        <Grid Grid.RowSpan="2"
              IsVisible="{Binding IsStoryOpen}"
              BackgroundColor="#000000CC"
              InputTransparent="False"
              ZIndex="9999">
            
            <!-- Ð¡Ñ†ÐµÐ½Ð° ÑÑ‚Ð¾Ñ€Ð¸Ñ (Ñ„Ð¾Ð½) -->
            <Grid>
                <Image x:Name="StoryImageA" Aspect="AspectFill" Opacity="1"/>
                <Image x:Name="StoryImageB" Aspect="AspectFill" Opacity="0"/>
                <Image Source="{Binding CurrentPageImage}"
                       Aspect="AspectFill"
                       HorizontalOptions="Fill"
                       VerticalOptions="Fill"
                       InputTransparent="True"/>
            </Grid>

            <!-- ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ (Ñ‚Ð°Ð¹Ð¼Ð»Ð°Ð¹Ð½) - Ð¿Ð¾Ð²ÐµÑ€Ñ… ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ -->
            <Grid Padding="12,8" Margin="0" 
                  VerticalOptions="Start"
                  x:Name="ProgressTimelineContainer">
                <HorizontalStackLayout Spacing="4"
                                      BindableLayout.ItemsSource="{Binding PageProgressList}"
                                      x:Name="ProgressStackLayout">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="x:Double">
                            <Grid HeightRequest="3" 
                                  HorizontalOptions="FillAndExpand"
                                  Margin="0">
                                <!-- Ð¤Ð¾Ð½ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ-Ð±Ð°Ñ€Ð° Ñ Ð¾ÐºÑ€ÑƒÐ³Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ ÑƒÐ³Ð»Ð°Ð¼Ð¸ -->
                                <Border HeightRequest="3"
                                        BackgroundColor="#FFFFFF55"
                                        StrokeThickness="0"
                                        HorizontalOptions="FillAndExpand">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="1.5"/>
                                    </Border.StrokeShape>
                                </Border>
                                <!-- ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ñ Ð¾ÐºÑ€ÑƒÐ³Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ ÑƒÐ³Ð»Ð°Ð¼Ð¸ -->
                                <Border HeightRequest="3"
                                        BackgroundColor="White"
                                        StrokeThickness="0"
                                        HorizontalOptions="Start">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="1.5"/>
                                    </Border.StrokeShape>
                                    <Border.WidthRequest>
                                        <MultiBinding>
                                            <MultiBinding.Converter>
                                                <converters:StoryProgressWidthConverter/>
                                            </MultiBinding.Converter>
                                            <Binding Path="."/>
                                            <Binding Path="BindingContext.CurrentStoryPageCount" Source="{x:Reference MainPageElement}"/>
                                            <Binding Path="BindingContext.ProgressTimelineContainerWidth" Source="{x:Reference MainPageElement}"/>
                                        </MultiBinding>
                                    </Border.WidthRequest>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </HorizontalStackLayout>
            </Grid>

            <!-- ÐÐ²Ð°Ñ‚Ð°Ñ€ÐºÐ° Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ - Ð¿Ð¾Ð²ÐµÑ€Ñ… ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ -->
            <HorizontalStackLayout Spacing="12"
                                   Padding="16,48,16,0"
                                   HorizontalOptions="Start"
                                   VerticalOptions="Start"
                                   InputTransparent="True">

                <Border WidthRequest="56" HeightRequest="56"
                        Stroke="White" StrokeThickness="2"
                        BackgroundColor="Transparent"
                        HorizontalOptions="Start"
                        VerticalOptions="Center">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="28" />
                    </Border.StrokeShape>
                    <Image Source="{Binding CurrentStory.Icon, Converter={StaticResource ImageSourceConverter}}"
                           Aspect="AspectFill" />
                </Border>

                <Label Text="{Binding CurrentStory.Title}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="White"
                       VerticalOptions="Center">
                    <Label.Shadow>
                        <Shadow Brush="#000000"
                                Opacity="0.8"
                                Radius="5"
                                Offset="1,1"/>
                    </Label.Shadow>
                </Label>
            </HorizontalStackLayout>

            <!-- ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ ÑÑ‚Ð¾Ñ€Ð¸Ñ -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid Grid.Column="0">
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding PrevPageCommand}"/>
                    </Grid.GestureRecognizers>
                </Grid>
                <Grid Grid.Column="1">
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NextPageCommand}"/>
                    </Grid.GestureRecognizers>
                </Grid>
            </Grid>
        </Grid>

        <!-- ====== OVERLAY: Banner (full-screen) ====== -->
        <Grid Grid.RowSpan="2"
              IsVisible="{Binding IsBannerOpen}"
              BackgroundColor="#000000CC"
              ZIndex="10000">
            <Image Source="{Binding CurrentBanner.Image}"
                   Aspect="AspectFill"
                   HorizontalOptions="Fill"
                   VerticalOptions="Fill"/>
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseBannerCommand}"/>
            </Grid.GestureRecognizers>
        </Grid>

    </Grid>
</ContentPage>